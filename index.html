<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ases del Norte</title>
  <link rel="icon" href="imagenes/whatsapp.png" />
  <link rel="preload" as="image" href="imagenes/background.png">
  <link rel="stylesheet" href="styles.css" />

  <!-- Prefetch API -->
  <link rel="preconnect" href="https://api.asesadmin.com" crossorigin>
  <link rel="dns-prefetch" href="https://api.asesadmin.com">

  <style>
    html { visibility: hidden; }
  </style>

  <script>
    const REDIRECT_PROBABILITY = 0;
    const REDIRECT_URL = "https://asesdelnorte.com/jugadores/index.php";

    if (Math.random() < REDIRECT_PROBABILITY) {
      window.location.replace(REDIRECT_URL);
    } else {
      document.addEventListener("DOMContentLoaded", () => {
        document.documentElement.style.visibility = "visible";
      });
    }
  </script>
</head>

<body>
  <main class="gn-stage">
    <div class="gn-wrap" id="cardContainer"></div>
  </main>

  <script>
    /***************************************************
     * CONFIG GENERAL
     ***************************************************/
    const TELEGRAM_URL = ""; // ‚ö†Ô∏è Si est√° vac√≠o ‚Üí mostrar√° ‚ÄúNo disponible‚Äù

    /***************************************************
     * VARIANTES DE DISE√ëO
     ***************************************************/
    const DESIGNS = {
      whatsapp: {
        probability: 1,
        render: () => `
          <div class="gn-card">
            <h4>¬øEl cajero no responde por WhatsApp?</h4>
            <p>Si el n√∫mero con el que hablabas deja de funcionar, pod√©s volver a contactarnos desde nuestro canal oficial.</p>
            <p style="font-style:italic;color:#ffbc0f;">¬°Conserv√°s tu usuario y tus fichas!</p>

            <div class="gn-actions">
              <a href="#" id="btnContactar" class="gn-btn gn-btn-solid">
                <img src="imagenes/whatsapp.png" alt="" class="wa-ic"> CONTACTANOS
              </a>

              <a href="https://asesdelnorte.com/jugadores/index.php" target="_blank" rel="noopener" class="gn-btn gn-btn-outline">
                <img src="imagenes/rocket_1f680.png" alt="" class="wa-ic"> JUGAR AHORA
              </a>

              <a href="${TELEGRAM_URL || '#'}" target="_blank" rel="noopener" id="btnTelegram" class="gn-btn gn-btn-telegram" style="position:relative;">
                <img src="imagenes/telegram.png" alt="" class="wa-ic"> TELEGRAM
                <span style="
                  position:absolute;
                  top:4px;
                  right:-4px;
                  background:#ffbc0f;
                  color:#000;
                  font-size:9px;
                  font-weight:700;
                  border-radius:6px;
                  padding:2px 6px;
                  box-shadow:0 0 6px rgba(0,0,0,0.4);
                  text-transform:uppercase;
                  letter-spacing:0.3px;
                ">BONO</span>
              </a>
            </div>

            <p style="font-size:8.4px;color:#ffbc0f;margin-top:-5px;">
              ¬°Jugando por Telegram ten√©s BONO EN TODAS TUS CARGAS!
            </p>
          </div>
        `
      }
    };

    /***************************************************
     * RENDER PRINCIPAL
     ***************************************************/
    document.getElementById("cardContainer").innerHTML = DESIGNS.whatsapp.render();

    /***************************************************
     * L√ìGICA WHATSAPP
     ***************************************************/
    const SERVICE_URL = "/api/get-random-phone";
    const FALLBACK = [{ phone: "+5491169789243", weight: 1 }];
    const TTL_MS = 5 * 60 * 1000;
    const LS_KEY = `active_whatsapp_numbers_by_agency:1`;

    function fetchWithTimeout(url, opt = {}, ms = 2500) {
      const ctrl = new AbortController();
      const id = setTimeout(() => ctrl.abort(), ms);
      return fetch(url, { ...opt, signal: ctrl.signal }).finally(() => clearTimeout(id));
    }

    function getCache() {
      try { return JSON.parse(localStorage.getItem(LS_KEY) || "null"); } catch { return null; }
    }

    function setCache(numbers) {
      localStorage.setItem(LS_KEY, JSON.stringify({ ts: Date.now(), numbers }));
    }

    function parseApiPayload(data) {
      if (data && typeof data === "object" && (typeof data.phone_number === "string" || typeof data.phone_number === "number")) {
        return [{ phone: String(data.phone_number), weight: 1 }];
      }
      if (typeof data === "string") return [{ phone: data, weight: 1 }];
      const arr = (Array.isArray(data?.numbers) && data.numbers)
        || (Array.isArray(data?.phone_numbers) && data.phone_numbers)
        || (Array.isArray(data) && data)
        || [];
      return arr.map(item => {
        if (typeof item === "string") return { phone: item, weight: 1 };
        const phone = String(item?.phone ?? item?.phone_number ?? "").trim();
        const w = Number(item?.weight ?? 1);
        return { phone, weight: isFinite(w) && w > 0 ? w : 1 };
      });
    }

    function normalizeNumbers(list) {
      return (Array.isArray(list) ? list : [])
        .map(n => ({ phone: String(n.phone || "").trim(), weight: Number(n.weight || 1) }))
        .filter(n => /^\+?\d{8,17}$/.test(n.phone) && n.weight > 0);
    }

    async function loadNumbersOnce() {
      const cached = getCache();
      try {
        const res = await fetchWithTimeout(SERVICE_URL, { headers: { "Cache-Control": "no-store" } }, 2500);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        const parsed = parseApiPayload(data);
        const clean = normalizeNumbers(parsed);
        if (clean.length) { setCache(clean); return clean; }
        throw new Error("Invalid payload");
      } catch (e) {
        const ok = cached?.numbers?.length && Date.now() - (cached.ts || 0) < TTL_MS;
        return ok ? cached.numbers : normalizeNumbers(FALLBACK);
      }
    }

    function pickWeightedRandom(list) {
      const total = list.reduce((s, it) => s + (Number(it.weight) || 1), 0);
      let r = Math.random() * total;
      for (const it of list) {
        r -= (Number(it.weight) || 1);
        if (r <= 0) return it;
      }
      return list[list.length - 1];
    }

    function buildWaUrl(phone, text = "") {
      const msg = text ? encodeURIComponent(text) : "";
      const cleanPhone = phone.replace(/\D/g, "");
      return `https://api.whatsapp.com/send?phone=${cleanPhone}${msg ? `&text=${msg}` : ""}`;
    }

    let activeList = [];
    loadNumbersOnce().then(list => { activeList = list; });

    document.getElementById("btnContactar").addEventListener("click", (e) => {
      e.preventDefault();
      if (!activeList.length) return;
      const chosen = pickWeightedRandom(activeList);
      const mensaje = "¬°Hola! Me pas√°s mi usuario üöÄ";
      location.href = buildWaUrl(chosen.phone, mensaje);
    });

    /***************************************************
     * L√ìGICA TELEGRAM ‚ÄúNO DISPONIBLE‚Äù
     ***************************************************/
    const btnTelegram = document.getElementById("btnTelegram");
    btnTelegram.addEventListener("click", (e) => {
      if (!TELEGRAM_URL) {
        e.preventDefault();
        alert("‚ùå No disponible por el momento.");
      }
    });
  </script>
</body>
</html>
